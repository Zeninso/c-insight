<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Analytics</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/teacher_Dashboard.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/teacher_analytics.css') }}">

    <style>
        .filter-section {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .analytics-container {
            animation: fadeIn 0.5s ease-in-out;
        }
        /* Fix for sidebar scrolling issue */
        .dashboard {
            display: flex !important;
            min-height: 100vh;
        }
        .sidebar {
            position: sticky !important;
            top: 0;
            height: 100vh;
            overflow-y: hidden;
            flex-shrink: 0;
        }
        .main-content {
            overflow-y: auto !important;
            flex: 1;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="dashboard">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-graduation-cap"></i>
                <h2>C-INSIGHT</h2>
            </div>
            <ul class="sidebar-nav">
                <li><a href="{{ url_for('teacher.teacherDashboard') }}"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                <li><a href="{{ url_for('teacher.teacherActivities') }}"><i class="fas fa-tasks"></i> Activities</a></li>
                <li><a href="{{ url_for('teacher.teacherClasses') }}"><i class="fas fa-users"></i> Classes</a></li>
                <li><a href="{{ url_for('teacher.teacherGrades') }}"><i class="fas fa-award"></i>Grades</a></li>
                <li><a href="{{ url_for('teacher.teacherAnalytics') }}" class="active"><i class="fas fa-chart-bar"></i> Analytics</a></li>
                <li><a href="{{ url_for('teacher.teacherSettings') }}"><i class="fas fa-cog"></i> Settings</a></li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <h1>Student Progress Analytics</h1>
                <div class="user-profile">
                    <a href="{{ url_for('auth.user_profile') }}">
                        <img src="https://ui-avatars.com/api/?name={{ session.first_name }}+{{ session.last_name }}&background=random&size=120" alt="User Profile" />
                    </a>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div class="notification-icon">
                            <a href="{{ url_for('teacher.notifications') }}" class="notification-icon" title="Notifications" style="position: relative; display: inline-block; color: inherit; text-decoration: none;">
                                <i class="fas fa-bell"></i>
                            </a>
                        </div>
                        <a href="#" onclick="confirmLogout()" class="btn btn-gradient">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </a>
                    </div>
                </div>
            </div>

            <!-- Content Section -->
            <div class="content-section">
                <!-- Modernized Filter section -->
                <div class="filter-section" style="margin-bottom: 20px; padding: 20px; background: linear-gradient(135deg, rgba(72, 40, 133, 0.05) 25%, rgba(214, 51, 132, 0.05) 100%); border-radius: 12px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); color: rgb(27, 27, 27);">
                    <form method="get" action="{{ url_for('teacher.teacherAnalytics') }}" class="filter-form" style="display: flex; flex-wrap: wrap; gap: 20px; align-items: center;">
                        <div class="filter-group" style="display: flex; flex-direction: column; min-width: 200px;">
                            <label for="classFilter" class="filter-label" style="font-weight: 600; margin-bottom: 5px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-users"></i> Filter by Class:
                            </label>
                            <select id="classFilter" name="class_id" class="filter-select" style="padding: 10px; border: none; border-radius: 8px; background: rgba(255, 255, 255, 0.9); color: #000000; font-size: 14px; min-width: 180px;">
                                <option value="">All Classes</option>
                                {% set selected_class_id = request.args.get('class_id') %}
                                {% for class in classes %}
                                    <option value="{{ class.id }}" {% if selected_class_id and selected_class_id|int == class.id %}selected{% endif %}>{{ class.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </form>
                </div>

                <!-- Analytics Content -->
                <div class="analytics-container">
                {% if student_progress %}
                    {% for student_data in student_progress %}
                        <div class="student-analytics-card" data-student-id="{{ student_data.student.id }}">
                            <div class="card-header">
                                <h3><i class="fas fa-user-graduate"></i> {{ student_data.student.first_name }} {{ student_data.student.last_name }}</h3>
                                <span class="username">@{{ student_data.student.username }}</span>
                            </div>

                            {% if student_data.progress %}
                                <div class="chart-container">
                                    <canvas id="chart-{{ student_data.student.id }}"></canvas>
                                </div>

                                <div class="progress-stats">
                                    <div class="stat-item">
                                        <h4>Total Submissions</h4>
                                        <span>{{ student_data.stats.total_submissions }}</span>
                                    </div>
                                    <div class="stat-item">
                                        <h4>Average Score</h4>
                                        <span>{{ student_data.stats.avg_total_score }}%</span>
                                    </div>
                                    <div class="stat-item">
                                        <h4>Latest Score</h4>
                                        <span>{{ student_data.progress[-1].total_score | round(2) }}%</span>
                                    </div>
                                </div>

                                <div class="weakness-analysis">
                                    <h4>Areas Needing Improvement:</h4>
                                    {% if student_data.stats.avg_correctness < 70 %}
                                        <span class="weakness-tag">Correctness</span>
                                    {% endif %}
                                    {% if student_data.stats.avg_syntax < 70 %}
                                        <span class="weakness-tag">Syntax</span>
                                    {% endif %}
                                    {% if student_data.stats.avg_logic < 60 %}
                                        <span class="weakness-tag">Logic</span>
                                    {% endif %}
                                    {% if student_data.stats.avg_similarity < 50 %}
                                        <span class="weakness-tag">Similarity</span>
                                    {% endif %}
                                </div>
                            {% else %}
                                <div class="no-data">
                                    <p>No submissions found for this student.</p>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                {% else %}
                    <div class="no-students">
                        <h3>No students found in your classes.</h3>
                        <p>Create classes and activities to start tracking student progress.</p>
                    </div>
                {% endif %}
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        function confirmLogout() {
            Swal.fire({
                title: 'Logout?',
                text: "Are you sure you want to logout?",
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: ' #6f42c1',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Yes, logout!'
            }).then((result) => {
                if (result.isConfirmed) {
                    window.location.href = "{{ url_for('auth.logout') }}";
                }
            });
        }

        // Chart data from server
        const studentData = JSON.parse('{{ student_progress_json|safe or "[]" }}');

        // Initialize charts for each student
        studentData.forEach(student => {
            if (student.progress && student.progress.length > 0) {
                const canvas = document.getElementById('chart-' + student.student.id);
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    const labels = student.progress.map(p => p.date);
                    const scores = student.progress.map(p => p.total_score);

                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Total Score',
                                data: scores,
                                borderColor: '#6f42c1',
                                backgroundColor: 'rgba(111, 66, 193, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    title: {
                                        display: true,
                                        text: 'Score (%)'
                                    }
                                },
                                x: {
                                    title: {
                                        display: true,
                                        text: 'Submission Date'
                                    }
                                }
                            }
                        }
                    });
                }
            }
        });

        // Auto-submit form when class selection changes
        document.addEventListener('DOMContentLoaded', function() {
            // Hide the submit button since we'll auto-submit
            document.querySelectorAll('.filter-submit').forEach(btn => {
                btn.classList.add('js-hidden');
            });

            // Auto-submit when class selection changes
            const classFilter = document.getElementById('classFilter');
            if (classFilter) {
                classFilter.addEventListener('change', function() {
                    this.form.submit();
                });
            }
        });
    </script>
</body>
</html>
